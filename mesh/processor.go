package mesh

import (
	"bufio"
	"errors"
	"fmt"
	"math"
	"os"
	"regexp"
	"strconv"
	"strings"
)

var (
	absolutePositioningCommandRegex = regexp.MustCompile("\\s*G90")
	relativePositioningCommandRegex = regexp.MustCompile("\\s*G91")
	homeAllCommandRegex             = regexp.MustCompile("\\s*G28")
	homeMinimumCommandRegex         = regexp.MustCompile("\\s*G161")
	homeMaximumCommandRegex         = regexp.MustCompile("\\s*G162")
	moveCommandRegex                = regexp.MustCompile("\\s*G[0-3] ")
	xRegex                          = regexp.MustCompile("X([-.\\d]+)")
	yRegex                          = regexp.MustCompile("Y([-.\\d]+)")
	zRegex                          = regexp.MustCompile("Z([-.\\d]+)")
)

func isValid(value float64) bool {
	return !(math.IsNaN(value) || math.IsInf(value, -1) || math.IsInf(value, 1))
}

func ProcessFile(filename string, mesh *Mesh, material string) (string, error) {
	file, err := os.Open(filename)
	if err != nil {
		return "", err
	}
	defer file.Close()

	scanner := bufio.NewScanner(file)
	var newLines []string

	// Insert custom FF Header
	//newLines = append(newLines, "xgcode 1.0")
	//header, _ := hex.DecodeString("00000000003A000000B0380000B03800007D1900005B0C000000000000010064000000030050003200C80000000101424D76380000000000003600000028000000500000003C000000010018000000000040380000C40E0000C40E000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003737374F4F4F5050505252525353536666666868686969696B6B6B6C6C6C6E6E6E6F6F6F5D5D5D5F5F5F4343434545454646460000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004747474848485A5A5A6969696A6A6A6D6D6D6E6E6E6F6F6F7272727474747575757777777979797A7A7A7C7C7C7D7D7D7F7F7F8181818282828484848585858787878989897979797B7B7B4848484A4A4A0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004040404242425F5F5F6161616363636565656868686969696A6A6A6D6D6D6F6F6F7070707272727474747575757777777979797A7A7A7C7C7C7D7D7D7E7E7E8181818282828484848585858787878989898A8A8A8C8C8C8D8D8D8E8E8E7E7E7E8080804D4D4D0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002C2C2C3F3F3F5959595B5B5B5D5D5D6060606161616363636565656868686969696A6A6A6D6D6D6F6F6F7070707272727474747575757777777979797A7A7A7C7C7C7D7D7D7E7E7E8181818282828383838585858787878989898A8A8A8B8B8B8D8D8D8E8E8E9090909292929393939595958484844F4F4F0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003F3F3F3F3F3F5959595959595A5A5A5B5B5B5D5D5D6060606161616464646565656868686A6A6A6B6B6B6D6D6D6F6F6F7070707272727474747575757777777979797A7A7A7C7C7C7D7D7D7E7E7E8181818282828383838585858787878989898A8A8A8B8B8B8D8D8D8E8E8E9090909292929393939595959696969797978686865151510000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003F3F3F3F3F3F5959595959595959595959595A5A5A5B5B5B5E5E5E6060606161616464646565656868686A6A6A6B6B6B6D6D6D6F6F6F7070707272727474747575757777777979797A7A7A7C7C7C7D7D7D7E7E7E8181818282828383838585858787878888888A8A8A8B8B8B8C8C8C8E8E8E9090909191919393939595959696969797979999999B9B9B8989895353530000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003F3F3F5959595959595959595959595959595959595A5A5A5B5B5B5E5E5E6060606262626464646666666868686A6A6A6B6B6B6D6D6D6F6F6F7070707272727474747575757777777979797A7A7A7C7C7C7D7D7D7E7E7E8181818282828383838585858787878888888A8A8A8B8B8B8C8C8C8E8E8E9090909191919393939494949696969797979898989B9B9B9C9C9C9D9D9D8C8C8C0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003F3F3F5959595959595959595959595959595959595959595959595A5A5A5C5C5C5E5E5E6060606262626464646666666868686A6A6A6B6B6B6D6D6D6F6F6F7070707272727474747575757777777979797A7A7A7C7C7C7D7D7D7E7E7E8181818282828383838585858787878888888A8A8A8B8B8B8C8C8C8E8E8E9090909191919393939494949696969797979898989A9A9A9C9C9C9D9D9D9F9F9FA0A0A05555550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003F3F3F5959595959595959595959595959595959595959595959595959595A5A5A5C5C5C5F5F5F6060606262626464646666666868686A6A6A6B6B6B6D6D6D6F6F6F7070707272727474747575757777777979797A7A7A7C7C7C7D7D7D7E7E7E8181818282828383838585858787878888888A8A8A8B8B8B8C8C8C8E8E8E9090909191919292929494949696969696969898989A9A9A9C9C9C9D9D9D9F9F9FA0A0A0A2A2A27777770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003F3F3F5959595959595959595959595959595959595959595959595959595959595A5A5A5C5C5C5F5F5F6161616262626464646666666868686A6A6A6C6C6C6D6D6D6F6F6F7070707272727474747575757777777979797A7A7A7C7C7C7D7D7D7E7E7E8181818282828383838585858686868888888A8A8A8B8B8B8C8C8C8E8E8E8F8F8F9191919292929494949696969696969898989A9A9A9B9B9B9D9D9D9F9F9FA0A0A0A2A2A2A4A4A47878780000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003F3F3F5959595959595959595959595959595959595959595959595959595959595959595A5A5A5D5D5D5F5F5F6161616262626464646767676868686A6A6A6C6C6C6D6D6D6F6F6F7171717272727474747575757777777979797A7A7A7C7C7C7D7D7D7E7E7E8181818181818383838585858686868888888A8A8A8B8B8B8C8C8C8E8E8E8F8F8F9191919292929494949595959696969797979999999B9B9B9C9C9C9E9E9EA0A0A0A1A1A1A3A3A3A5A5A57979790000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002C2C2C5959595959595959595959595959595959595959595959595959595959595959595959595A5A5A5D5D5D5F5F5F6161616262626565656767676868686A6A6A6C6C6C6D6D6D6F6F6F7171717272727474747575757777777979797A7A7A7C7C7C7D7D7D7E7E7E8181818181818383838585858686868888888A8A8A8B8B8B8C8C8C8D8D8D8F8F8F9090909292929494949595959696969797979999999B9B9B9C9C9C9E9E9EA0A0A0A1A1A1A3A3A3A5A5A5A6A6A67A7A7A0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005959595959595959595959595959595959595959595959595959595959595959595959595959595B5B5B5D5D5D5F5F5F6161616262626565656767676868686A6A6A6C6C6C6D6D6D6F6F6F7171717272727575757575757777777979797A7A7A7C7C7C7D7D7D7E7E7E8080808181818383838585858686868888888A8A8A8B8B8B8C8C8C8D8D8D8E8E8E9090909292929393939595959696969797979999999B9B9B9C9C9C9E9E9E9F9F9FA1A1A1A3A3A3A5A5A5A6A6A6A7A7A70000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003F3F3F5959595959595959595959595959595959595959595959595959595959595959595959595A5A5A5B5B5B5D5D5D6060606161616363636565656767676969696A6A6A6C6C6C6D6D6D6F6F6F7171717272727575757575757777777979797A7A7A7C7C7C7D7D7D7E7E7E8080808181818383838585858585858888888989898A8A8A8C8C8C8D8D8D8E8E8E9090909292929393939595959696969797979999999B9B9B9C9C9C9D9D9D9F9F9FA1A1A1A3A3A3A4A4A4A6A6A6A7A7A77A7A7A0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005959595959595959595959595959595959595959595959595959595959595959595959595959595A5A5A5B5B5B5D5D5D6060606161616363636565656767676969696A6A6A6C6C6C6D6D6D6F6F6F7171717272727575757575757777777979797A7A7A7C7C7C7D7D7D7E7E7E8080808181818383838484848585858888888989898A8A8A8C8C8C8D8D8D8E8E8E9090909292929393939595959696969797979898989A9A9A9C9C9C9D9D9D9F9F9FA0A0A0A2A2A2A4A4A4A6A6A6A7A7A7A8A8A80000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002C2C2C5959595959595959595959595959595959595959595959595959595959595959595959595959595A5A5A5B5B5B5D5D5D6060606161616363636565656767676969696A6A6A6C6C6C6E6E6E6F6F6F7171717272727575757575757777777979797A7A7A7C7C7C7D7D7D7E7E7E8080808181818383838484848585858888888989898A8A8A8C8C8C8D8D8D8E8E8E9090909292929393939494949696969797979898989A9A9A9C9C9C9D9D9D9F9F9FA0A0A0A2A2A2A4A4A4A5A5A5A6A6A6A8A8A86363630000000000000000000000000000000000000000000000000000000000000000000000000000000000004D4D4D5959595959595959595959595959595959595959595959595959595959595959595959595959595A5A5A5B5B5B5E5E5E6060606161616363636565656767676969696A6A6A6C6C6C6E6E6E6F6F6F7171717272727575757575757777777979797A7A7A7C7C7C7D7D7D7E7E7E8080808181818383838484848585858888888989898A8A8A8C8C8C8D8D8D8E8E8E9090909191919393939494949696969797979898989A9A9A9C9C9C9D9D9D9F9F9FA0A0A0A2A2A2A3A3A3A5A5A5A6A6A6A8A8A87B7B7B0000000000000000000000000000000000000000000000000000000000000000000000000000000000004D4D4D5959595959595959595959595959595959595959595959595959595959595959595959595959595A5A5A5C5C5C5E5E5E6060606161616464646565656868686969696A6A6A6C6C6C6E6E6E6F6F6F7171717272727575757575757777777979797A7A7A7C7C7C7D7D7D7E7E7E8080808181818383838484848585858888888989898A8A8A8B8B8B8C8C8C8E8E8E9090909191919292929494949696969696969898989999999B9B9B9C9C9C9E9E9EA0A0A0A1A1A1A3A3A3A5A5A5A6A6A6A8A8A89494940000000000000000000000000000000000000000000000000000000000000000000000000000000000005959595959595959595959595959595959595959595959595959595959595959595959595959595959595A5A5A5C5C5C5E5E5E6060606262626464646565656868686969696A6A6A6D6D6D6E6E6E6F6F6F7171717272727575757575757777777979797A7A7A7C7C7C7D7D7D7E7E7E8080808181818383838484848585858787878989898A8A8A8B8B8B8C8C8C8E8E8E9090909191919292929494949696969696969797979999999B9B9B9C9C9C9E9E9EA0A0A0A1A1A1A3A3A3A4A4A4A6A6A6A7A7A7A9A9A90000000000000000000000000000000000000000000000000000000000000000000000000000002C2C2C5959595959595959595959595959595959595959595959595959595959595959595959595959595959595A5A5A5C5C5C5F5F5F6060606262626464646565656868686969696A6A6A6D6D6D6E6E6E6F6F6F7171717272727575757575757777777979797A7A7A7C7C7C7D7D7D7E7E7E8080808181818383838484848585858787878989898A8A8A8B8B8B8C8C8C8E8E8E9090909191919292929494949595959696969797979999999B9B9B9C9C9C9E9E9E9F9F9FA1A1A1A3A3A3A4A4A4A6A6A6A7A7A7A8A8A80000000000000000000000000000000000000000000000000000000000000000000000000000002C2C2C5959595959595959595959595959595959595959595959595959595959595959595959595959595959595A5A5A5D5D5D5F5F5F6161616262626464646666666868686969696A6A6A6D6D6D6E6E6E6F6F6F7171717272728888888888888A8A8A8B8B8B8C8C8C8E8E8E8E8E8E9090909292928181818383838484848585858787878989898A8A8A8B8B8B8C8C8C8E8E8E8F8F8F9191919292929494949595959696969797979999999B9B9B9C9C9C9D9D9D9F9F9FA0A0A0A2A2A2A4A4A4A6A6A6A7A7A7A8A8A87C7C7C0000000000000000000000000000000000000000000000000000000000000000000000003F3F3F5959595959595959595959595959595959595959595959595959595959595959595959595959595959595A5A5A5D5D5D5F5F5F6161616262627979798C8C8C8D8D8D8F8F8F9E9E9EA0A0A0AEAEAEAFAFAFB0B0B0B1B1B1B2B2B2B3B3B3B4B4B4B6B6B6B7B7B7B8B8B8B9B9B9BABABABBBBBBBBBBBBBDBDBDBDBDBDB2B2B2B4B4B4B5B5B5A9A9A99B9B9B9C9C9C8E8E8E8F8F8F9090909292929494949595959696969797979999999B9B9B9C9C9C9D9D9D9F9F9FA0A0A0A2A2A2A4A4A4A5A5A5A6A6A6A8A8A87B7B7B0000000000000000000000000000000000000000000000000000000000000000000000004D4D4D5959595959595959595959595959595959595959595959595959595959595959595959595959595A5A5A717171858585878787979797A5A5A5A7A7A7A8A8A8A9A9A9ABABABABABABADADADB2B2B2B2B2B2B3B3B3B6B6B6B7B7B7B8B8B8B8B8B8B9B9B9B9B9B9BABABABABABABBBBBBBBBBBBBCBCBCBDBDBDBDBDBDBEBEBEC0C0C0C0C0C0C2C2C2C3C3C3C3C3C3C4C4C4BABABABBBBBBA1A1A1A2A2A29595959696969797979898989A9A9A9C9C9C9D9D9D9F9F9FA0A0A0A2A2A2A3A3A3A5A5A5A6A6A6A8A8A89595950000000000000000000000000000000000000000000000000000000000000000000000004D4D4D5959595959595959595959595959595959595959595959595959595959595959598080808181819F9F9FA0A0A0A2A2A2A3A3A3A4A4A4ABABABB2B2B2B2B2B2B8B8B8BCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBEBEBEBEBEBEBEBEBEC0C0C0C2C2C2C6C6C6C6C6C6C7C7C7C9C9C9C9C9C9BFBFBFA6A6A6A7A7A79A9A9A9C9C9C9C9C9C9F9F9FA0A0A0A1A1A1A3A3A3A5A5A5A6A6A6A7A7A7A9A9A90000000000000000000000000000000000000000000000000000000000000000000000005959595959595959595959595959595959595959595959595959597D7D7D8C8C8C9A9A9A9C9C9C9D9D9DA7A7A7AFAFAFAFAFAFBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBFBFBFBFBFBFC6C6C6C6C6C6CACACACBCBCBCCCCCCC2C2C2AAAAAA9C9C9C9E9E9EA0A0A0A1A1A1A3A3A3A4A4A4A6A6A6A7A7A7A8A8A80000000000000000000000000000000000000000000000000000000000000000002C2C2C5959595959595959595959595959595959595959597B7B7B959595979797999999ACACACADADADBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCC0C0C0C8C8C8CECECECFCFCFCFCFCFC5C5C5ADADADA1A1A1A3A3A3A4A4A4A6A6A6A7A7A7A8A8A85959590000000000000000000000000000000000000000000000000000000000003F3F3F595959595959595959595959595959797979929292939393AAAAAAABABABBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCADADADA1A1A1A5A5A5A7A7A7ABABABA7A7A7ACACACAEAEAECBCBCBA5A5A5929292959595999999A0A0A09A9A9A9C9C9CADADADAAAAAAAAAAAABCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCC1C1C1CBCBCBD0D0D0D1D1D1C7C7C7B0B0B0A4A4A4A5A5A5A6A6A6A8A8A87B7B7B0000000000000000000000000000000000000000000000000000000000004D4D4D5959595959595959597676768E8E8E8F8F8FA8A8A8BCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCC4C4C4B3B3B3959595939393808080989898B2B2B2B8B8B8BEBEBEBBBBBBC1C1C1AFAFAFA7A7A7A9A9A98A8A8A7575757979797C7C7C8B8B8B8F8F8F7474746A6A6A6969695959595959595959597C7C7C8181819C9C9CAFAFAFBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCC2C2C2CCCCCCD2D2D2D3D3D3BEBEBEA5A5A5A6A6A6A8A8A87B7B7B0000000000000000000000000000000000000000000000000000000000004D4D4D5959596767677F7F7F8B8B8BA7A7A7BCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCC1C1C1C8C8C8CFCFCFD7D7D7D8D8D8C2C2C2707070A7A7A7BCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCC1C1C1CDCDCDCCCCCCB6B6B65959595959595959595959595959595959596B6B6B6F6F6F6060605959595959595959597070708989899393939E9E9EA5A5A5ABABABB1B1B1B7B7B7BCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCC2C2C2CECECED4D4D4CACACAB3B3B3A8A8A8A9A9A9000000000000000000000000000000000000000000000000000000000000595959676767878787888888A6A6A6BCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCB5B5B5CBCBCBD0D0D0D4D4D4D6D6D6D8D8D8D8D8D8C4C4C4AEAEAEBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCC4C4C4C2C2C27070707474747777777979797373737474746868686969695959595959597373739D9D9DACACACB7B7B7B9B9B9BBBBBBBDBDBDBFBFBFCBCBCBCACACAABABABA6A6A6B7B7B7BCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCC3C3C3D5D5D5D5D5D5B4B4B4A8A8A80000000000000000000000000000000000000000000000000000002C2C2C656565838383959595B1B1B1BCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBC9A9A9A9E9E9E848484909090999999AEAEAECBCBCBD8D8D8D8D8D8D6D6D6D2D2D2BCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBABABA7777777B7B7B7F7F7F8282828686868989898C8C8C909090797979797979A3A3A3BCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCC3C3C3BBBBBB9F9F9FA6A6A6B1B1B1BABABABCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCC3C3C3D0D0D0D7D7D7B6B6B65959590000000000000000000000000000000000000000000000002C2C2C787878939393BCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBC9696966D6D6D7A7A7A868686909090999999A2A2A2A7A7A7C2C2C2D6D6D6D1D1D1B4B4B4959595BCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBC8F8F8F7878787B7B7B7F7F7F8282828686868989898C8C8C909090808080ADADADBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCA0A0A09B9B9BA4A4A4AEAEAEB6B6B6ACACACACACACBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCD1D1D1D7D7D77B7B7B0000000000000000000000000000000000000000000000005959597E7E7EB0B0B0BCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBC7B7B7B5F5F5F6D6D6D7A7A7A8787879292929B9B9BA2A2A2A7A7A7A9A9A9C4C4C49D9D9D5959595959595959597B7B7BAAAAAAAAAAAABCBCBCBCBCBCBCBCBCB8B8B8B5B5B5AFAFAFB2B2B2B5B5B5B7B7B7BABABABDBDBDB3B3B3B5B5B5B8B8B8ADADADA2A2A2B0B0B0BCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCA4A4A49090909B9B9B8787879191919C9C9CA7A7A7A9A9A9ACACACBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCC3C3C3D8D8D89E9E9E0000000000000000000000000000000000000000000000006B6B6BA0A0A0BCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBEBEBE7D7D7D7C7C7C949494B1B1B1B8B8B8BFBFBFB9B9B9C3C3C3B0B0B0A8A8A8A9A9A98585855959595959595959597B7B7B7D7D7D9A9A9A9D9D9DA0A0A0A3A3A3ACACACB3B3B3B4B4B4B6B6B6B7B7B7BABABABBBBBBBBBBBBBCBCBCBEBEBEC0C0C0C2C2C2C4C4C4C9C9C9CBCBCBC4C4C4C1C1C1BCBCBCBCBCBCBCBCBCBCBCBCB7B7B79C9C9C7878786F6F6F5959595959595D5D5D6A6A6A787878868686949494939393999999BCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCCBCBCBBEBEBE000000000000000000000000000000000000000000000000787878AFAFAFBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBEBEBEAEAEAE929292BCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCC3C3C3C6C6C6B6B6B67171715959597575758F8F8F929292A0A0A0ABABABB5B5B5BCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCC0C0C0C5C5C5CACACAD1D1D1D3D3D3BEBEBEA6A6A6A8A8A88E8E8E6666665959595959595959595B5B5B6767677676768585859191919E9E9E8B8B8B999999BCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCD8D8D80000000000000000000000000000000000000000000000008B8B8BBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCC4C4C48D8D8D9E9E9EBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCC9C9C96F6F6F858585898989A7A7A7BCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCAFAFAFAEAEAEBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCC2C2C2C8C8C8D5D5D5D6D6D6B5B5B5A9A9A95D5D5D5959595959595959597070707B7B7B878787939393A0A0A09C9C9C989898676767BCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCD8D8D80000000000000000000000000000000000000000000000007F7F7FBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCC0C0C0BFBFBF888888777777AFAFAFBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCA5A5A57E7E7EA3A3A3BCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCB0B0B0AEAEAEA3A3A39393938C8C8C8686867D7D7D7575756D6D6D6464645B5B5B7B7B7B7B7B7BAAAAAABCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCCACACAD8D8D8C3C3C3767676646464747474A9A9A9AEAEAEB8B8B8BABABABDBDBDBFBFBFCBCBCBC1C1C1646464ACACACBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCB6B6B6000000000000000000000000000000000000000000000000515151BCBCBCBCBCBCBCBCBCBCBCBCBCBCBCC0C0C0C2C2C2A0A0A08D8D8D7A7A7A969696A1A1A1ABABABADADADB0B0B0B2B2B2B9B9B9B1B1B1787878A0A0A0BCBCBCBCBCBCBCBCBCBCBCBCBCBCBCB8B8B8B3B3B3A7A7A7A4A4A49F9F9F9A9A9A9393938C8C8C8686867D7D7D7575756D6D6D6464645B5B5B5959595959595959595959597B7B7BAAAAAABCBCBCBCBCBCBCBCBCBCBCBCBCBCBCCBCBCBD8D8D88F8F8F9E9E9EBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCCACACA646464ACACACBCBCBCBCBCBCBCBCBCBCBCBCBCBCBC7373730000000000000000000000000000000000000000000000000000009B9B9BBCBCBCBCBCBCBCBCBCBCBCBCC1C1C1D0D0D0A1A1A1A5A5A57D7D7D6D6D6D5959596060607373738282828E8E8E9A9A9A9898988A8A8ABCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBABABAA8A8A8A9A9A9A7A7A7A3A3A39F9F9F9A9A9A9393938B8B8B8686867D7D7D7575756D6D6D6464645B5B5B595959595959595959595959595959595959999999BCBCBCBCBCBCBCBCBCBCBCBCBCBCBCD1D1D19F9F9FBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBC7F7F7F696969ACACACBCBCBCBCBCBCBCBCBCBCBCBCA5A5A5000000000000000000000000000000000000000000000000000000000000373737BCBCBCBCBCBCBCBCBCBCBCBCBCBCBCC7C7C7BDBDBDA6A6A6A7A7A75959595959596262627575758282829090909B9B9BA3A3A39B9B9BBCBCBCBCBCBCBCBCBCBCBCBCC1C1C1C6C6C6A8A8A8A9A9A9A7A7A7A3A3A39F9F9F9A9A9A9393938B8B8B8686867D7D7D7575756D6D6D6464645B5B5B595959595959595959595959595959595959666666BCBCBCBCBCBCBCBCBCBCBCBCBCBCBCC9C9C9A3A3A3A2A2A2B2B2B2B5B5B5BCBCBCBCBCBCAAAAAA959595959595595959676767858585BCBCBCBCBCBCBCBCBCBCBCBCBCBCBC6464640000000000000000000000000000000000000000000000000000000000000000008A8A8ABCBCBCBCBCBCBCBCBCBCBCBCC2C2C2D5D5D5BFBFBFA7A7A75959597F7F7F8B8B8BA5A5A5B3B3B3AFAFAFAAAAAAB2B2B2A2A2A2BCBCBCBCBCBCBCBCBCBCBCBCBCBCBCD6D6D6C2C2C2A9A9A9A7A7A7A3A3A39F9F9F9A9A9A9393938B8B8B8686867D7D7D7575756D6D6D6464645C5C5C5959595959595959595959595959596868686E6E6EACACACBCBCBCBCBCBCBCBCBCBCBCBCA0A0A07070708383839090909E9E9EC1C1C18686865959595959595959596464646D6D6DACACACBCBCBCBCBCBCBCBCBCBCBCBC9393930000000000000000000000000000000000000000000000000000000000000000000000000000008A8A8ABCBCBCBCBCBCBCBCBCBCBCBCC9C9C9D6D6D6C1C1C1A3A3A3BCBCBCBCBCBCBCBCBCBCBCBCBCBCBCC1C1C1C3C3C3CECECEB1B1B1BCBCBCBCBCBCBCBCBCBCBCBCCBCBCBD8D8D8CDCDCDB4B4B4A3A3A39F9F9F9A9A9A9393938B8B8B8686867D7D7D7777776D6D6D6464645C5C5C5959595959595959595959596D6D6D7878789D9D9DBCBCBCBCBCBCBCBCBCBCBCBC9595956060607070707F7F7F8F8F8F9D9D9D9999995959595959595959596666666F6F6F9B9B9BBCBCBCBCBCBCBCBCBCBCBCBC8A8A8A000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000646464A5A5A5BCBCBCBCBCBCBCBCBCC3C3C3D1D1D1CBCBCBBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBC959595909090BCBCBCBCBCBCBCBCBCBCBCBCC4C4C4D0D0D0D5D5D5C8C8C8B9B9B9A7A7A7A2A2A28B8B8B8585857D7D7D7777776D6D6D6464645C5C5C6E6E6E7A7A7A848484888888A2A2A2BCBCBCBCBCBCBCBCBCBCBCBCBCBCBC9C9C9C7C7C7C9D9D9DA6A6A6AEAEAEB7B7B7C4C4C4A6A6A6595959595959686868727272ADADADBCBCBCBCBCBCBCBCBCBCBCBC6464640000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008A8A8ABCBCBCBCBCBCBCBCBCBCBCBCCBCBCBD2D2D2CBCBCBC4C4C4B8B8B8B7B7B7B7B7B7B1B1B1A4A4A47171715959596161617B7B7BAAAAAABCBCBCBCBCBCBCBCBCBCBCBCC2C2C2CACACAC8C8C8C7C7C7C2C2C2BEBEBEB9B9B9B3B3B3ADADADA8A8A8A2A2A2A4A4A4ABABABA8A8A8BCBCBCBCBCBCBCBCBCBCBCBCBCBCBC959595868686A2A2A2BCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCCACACA6A6A6A7878789D9D9DBCBCBCBCBCBCBCBCBCBCBCBC8A8A8A000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000646464A5A5A5BCBCBCBCBCBCBCBCBCC4C4C4D2D2D2D8D8D8CDCDCDB5B5B5A7A7A7A6A6A6A5A5A5A3A3A39393938383835959597070709696969F9F9FBEBEBEBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCB8B8B89595957B7B7B595959595959959595BCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCB0B0B0909090A0A0A0BCBCBCBCBCBCBCBCBCBCBCBC8A8A8A0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006464648A8A8AA5A5A5BCBCBCBCBCBCBCBCBCC3C3C3D0D0D0D6D6D6CBCBCBB2B2B2A3A3A3A1A1A1898989A6A6A6ACACACB9B9B9BCBCBCBFBFBFC1C1C1C4C4C4B5B5B58686869D9D9D9C9C9C9C9C9C9B9B9B9A9A9A959595ABABABB0B0B0BABABABDBDBDB0B0B0AEAEAE9999995959595959595959595959595959597B7B7B7B7B7BA6A6A6A4A4A4969696949494A2A2A2BCBCBCBCBCBCBCBCBCBCBCBC8A8A8A000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000646464A5A5A5A5A5A5BCBCBCBCBCBCC3C3C3C3C3C3CFCFCFD3D3D3C7C7C7BEBEBEBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCBCADADAD8989898585858181817F7F7F7C7C7C757575A1A1A1BCBCBCBCBCBCBCBCBCBCBCBCBCBCBCC3C3C3BABABA5959595959596D6D6D7C7C7C7A7A7A8686868D8D8DA6A6A6A5A5A5BCBCBCBCBCBCBCBCBCBCBCBC8A8A8A8A8A8A000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000646464646464A5A5A5BCBCBCBCBCBCBCBCBCC2C2C2C1C1C1C6C6C6C5C5C5C0C0C0C3C3C3C2C2C2C1C1C1B7B7B7AAAAAA9999999696969393939090908D8D8D8A8A8AABABABB9B9B9BCBCBCBCBCBCBCBCBCBCBCBCB0B0B09B9B9B9E9E9E9B9B9BA2A2A2ABABABA9A9A9BCBCBCBCBCBCBCBCBCBCBCBC8A8A8A8A8A8A6464640000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006464646464648A8A8AA5A5A5A5A5A5BCBCBCBCBCBCBCBCBCBFBFBFBEBEBEBEBEBEBFBFBFBEBEBEBDBDBDBCBCBCBBBBBBBABABAB9B9B9B7B7B7B6B6B6B5B5B5B4B4B4B2B2B2B7B7B7B6B6B6BCBCBCBCBCBCBCBCBCBCBCBCA5A5A5A5A5A58A8A8A8A8A8A0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006464646464646464648A8A8A8A8A8A8A8A8AA5A5A5A5A5A5A5A5A5A5A5A5A5A5A5A5A5A5A5A5A5A5A5A5A5A5A58A8A8A8A8A8A8A8A8A8A8A8A6464646464640000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003B67656E657261746564206279206666736C6963657220312E33302E312030332F30392F32312031383A34323A3139")
	//newLines = append(newLines, string(header))
	//newLines = append(newLines, ";machine_type: FlashForge Adventurer 3\n;right_extruder_material: PLA\n;layer_height: 0.1\n;perimeter_shells: 3\n;top_solid_layers: 5\n;bottom_solid_layers: 4\n;fill_density: 25%\n;fill_pattern: hexagon\n;base_print_speed: 80\n;travel_speed: 140\n;right_extruder_temperature: 200\n;left_extruder_temperature: 0\n;platform_temperature: 50\n;right_extruder_temperature_raft0: 0\n;left_extruder_temperature_raft0: 0\n;right_extruder_temperature_reset: \n;left_extruder_temperature_reset: \n;start gcode")

	// Current printer positions
	relativePositioning := true
	// The current printer position **without offset**
	var x, y, z float64
	for scanner.Scan() {
		line := scanner.Text()
		if !strings.HasPrefix(strings.TrimSpace(line), ";") {
			if moveCommandRegex.MatchString(line) {
				// This is a gcode move instruction!
				var updateRegex *regexp.Regexp
				var updatePrefix string

				if xRegex.MatchString(line) {
					matches := xRegex.FindAllStringSubmatch(line, -1)
					if len(matches) != 1 {
						return "", fmt.Errorf("invalid x argument count (%d): %s", len(matches), line)
					}
					if len(matches[0]) != 2 {
						return "", errors.New("x regex error")
					}

					updateRegex = xRegex
					updatePrefix = matches[0][0] + " "

					newX, err := strconv.ParseFloat(matches[0][1], 64)
					if err != nil {
						return "", err
					}
					if relativePositioning {
						x += newX
					} else {
						x = newX
					}
				}
				if yRegex.MatchString(line) {
					matches := yRegex.FindAllStringSubmatch(line, -1)
					if len(matches) != 1 {
						return "", fmt.Errorf("invalid y argument count (%d): %s", len(matches), line)
					}
					if len(matches[0]) != 2 {
						return "", errors.New("y regex error")
					}

					updateRegex = yRegex
					updatePrefix = matches[0][0] + " "

					newY, err := strconv.ParseFloat(matches[0][1], 64)
					if err != nil {
						return "", err
					}
					if relativePositioning {
						y += newY
					} else {
						y = newY
					}
				}
				if zRegex.MatchString(line) {
					matches := zRegex.FindAllStringSubmatch(line, -1)
					if len(matches) != 1 {
						return "", fmt.Errorf("invalid z argument count (%d): %s", len(matches), line)
					}
					if len(matches[0]) != 2 {
						return "", errors.New("z regex error")
					}

					updateRegex = zRegex
					updatePrefix = ""

					newZ, err := strconv.ParseFloat(matches[0][1], 64)
					if err != nil {
						return "", err
					}
					if relativePositioning {
						z += newZ
					} else {
						z = newZ
					}
				}

				if updateRegex != nil && !math.IsNaN(x) && !math.IsNaN(y) {
					zOffset, err := mesh.GetZOffsetAtPosition(x, y, material)
					if err != nil {
						return "", err
					}
					adjustedZ := z + zOffset
					if isValid(adjustedZ) && adjustedZ != z {
						// TODO split up moves to eg. go over a hill
						line = updateRegex.ReplaceAllString(line, updatePrefix+"Z"+strconv.FormatFloat(adjustedZ, 'f', 3, 64))
					}
				}
			} else if homeAllCommandRegex.MatchString(line) || homeMinimumCommandRegex.MatchString(line) {
				movex := strings.ContainsRune(line, 'X')
				movey := strings.ContainsRune(line, 'Y')
				movez := strings.ContainsRune(line, 'Z')
				if !(movex || movey || movez) {
					x = math.Inf(-1)
					y = math.Inf(-1)
					z = 0
				} else {
					if movex {
						x = math.Inf(-1)
					}
					if movey {
						y = math.Inf(-1)
					}
					if movez {
						z = 0
					}
				}
			} else if homeMaximumCommandRegex.MatchString(line) {
				movex := strings.ContainsRune(line, 'X')
				movey := strings.ContainsRune(line, 'Y')
				movez := strings.ContainsRune(line, 'Z')
				if !(movex || movey || movez) {
					x = math.Inf(1)
					y = math.Inf(1)
					z = math.Inf(1)
				} else {
					if movex {
						x = math.Inf(1)
					}
					if movey {
						y = math.Inf(1)
					}
					if movez {
						z = math.Inf(1)
					}
				}
			} else if absolutePositioningCommandRegex.MatchString(line) {
				relativePositioning = false
			} else if relativePositioningCommandRegex.MatchString(line) {
				relativePositioning = true
			}
		}
		newLines = append(newLines, line)
	}

	return strings.Join(newLines, "\n"), nil
}
